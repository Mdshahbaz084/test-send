<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Push Notification</title>
    <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-messaging.js"></script>
    <style>
        .hidden { display: none; }
    </style>
</head>
<body>
    <h1>Firebase Push Notification Example</h1>
    <button id="notify-btn">Enable Notifications</button>
    
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBfqQkLMdirE1s3QDAU-k8kZJDSJ-AHfxI",
            authDomain: "madrsa-sikariya.firebaseapp.com",
            projectId: "madrsa-sikariya",
            storageBucket: "madrsa-sikariya.firebasestorage.app",
            messagingSenderId: "1066102927865",
            appId: "1:1066102927865:web:d5e649be4178d363408d28",
            measurementId: "G-3S96TVYFJC"
        };

        firebase.initializeApp(firebaseConfig);
        const messaging = firebase.messaging ? firebase.messaging() : null;
        const notifyBtn = document.getElementById("notify-btn");

        function encryptToken(token) {
            return btoa(token); // Basic encoding, consider stronger encryption if needed
        }

        function requestNotificationPermission() {
            Notification.requestPermission().then(permission => {
                if (permission === "granted" && messaging) {
                    messaging.getToken({ vapidKey: "BClpcTQygEYX1ueX4n8GTMN0UmSsaeM1JwpbRoI81WxOaHGB4gQHJl-bNiyBJmp_c5CryDL0NGiWAd2a7z3CpB4" })
                        .then(currentToken => {
                            if (currentToken) {
                                console.log("FCM Token:", currentToken);
                                sessionStorage.setItem("fcm_token", encryptToken(currentToken));
                                notifyBtn.classList.add("hidden");
                            } else {
                                console.error("No registration token available.");
                            }
                        })
                        .catch(err => console.error("Error retrieving token:", err));
                } else if (permission === "default") {
                    console.warn("Notification permission request dismissed.");
                } else {
                    console.warn("Notification permission denied.");
                    sessionStorage.removeItem("fcm_token");
                }
            }).catch(err => console.error("Error requesting notification permission:", err));
        }

        if (!sessionStorage.getItem("fcm_token")) {
            notifyBtn.classList.remove("hidden");
        } else {
            notifyBtn.classList.add("hidden");
        }

        notifyBtn.addEventListener("click", requestNotificationPermission);

        if (messaging) {
            messaging.onMessage(payload => {
                if (payload.notification) {
                    console.log("Message received:", payload);
                    new Notification(payload.notification.title, {
                        body: payload.notification.body,
                        icon: payload.notification.icon
                    });
                } else {
                    console.warn("Received message payload does not contain notification data.", payload);
                }
            });
        } else {
            console.error("Firebase messaging is not available.");
        }
    </script>
</body>
</html>
